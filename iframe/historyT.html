<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>新乡流量监控平台</title>
    <link rel="stylesheet" href="../css/layui.css">
    <link rel="stylesheet" href="../css/modules/laydate/default/laydate.css">
    <link rel="stylesheet" href="../css/modules/layer/default/layer.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/map.css">
    <style>
        .layui-form-item {
            clear: none;
        }

        .layui-table-cell {
            height: inherit;
        }

        .layui-table-box {
            border-bottom: 1px solid #ccc
        }


        .layui-table-view .layui-table th:first-child {
            padding: 0 !important;
        }


        .layui-table-view .layui-table th:first-child div {
            padding: 0 !important;
        }

        .layui-table img {
            max-width: 160px;
        }

        .canv {
            width: 840px;
            height: 400px;
        }

        .layui-form-checkbox[lay-skin=primary] {
            height: auto !important;
            line-height: normal !important;
            min-width: 18px;
            min-height: 18px;
            border: none !important;
            margin-right: 0;
            padding-left: 28px;
            padding-right: 0;
            background: 0 0;
            width: 160px;
            margin: 10px 0;
        }

        #sbC {
            height: 160px;
            overflow-y: auto;
            width: 98%;
            margin-left: 2%;
        }
    </style>
</head>

<div class="container">

    <div class="layui-row lrow">
        <a href="javascript:;">当前位置：</a>
        <span class="layui-breadcrumb" lay-separator=">">
            <a href="../index.html" target="_top">首页</a>
            <a href="javascript:;">数据查询</a>
            <a href="javascript:;">设备数据</a>
        </span>
    </div>

    <div class="padd"></div>
    <form class="layui-form" lay-filter="example" style="display: flex;">
        <!-- 提示：如果你不想用form，你可以换成div等任何一个普通元素 -->
        <div class="layui-form-item">
            <label class="layui-form-label">选择企业</label>
            <div class="layui-input-block">

                <select name="mn" lay-filter="qy" id="qylist">

                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">选择设备</label>
            <div class="layui-input-block">
                <select name="mcodes" lay-filter="seb" id="mcodes">

                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">开始时间</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" id="stime" name="stime" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">结束时间</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" id="etime" name="etime" autocomplete="off">
            </div>
        </div>

        <div class="layui-form-item" id="hide" style="margin-left: 25px;">
            <div class="layui-input-inline">
                <button type="button" class="layui-btn  layui-btn-radius  layui-btn-normal " lay-submit
                    lay-filter="sub">查询</button>
                <!-- <button type="reset" class="layui-btn layui-btn-radius layui-btn-normal" lay-submit
                    lay-filter="reset">重置
                </button> -->
            </div>
        </div>

    </form>

    <div class="layui-form" style="clear: both;">
        <table id="demo" lay-filter="demo">
            <!-- <thead>
                <tr>
                    <th lay-data="{field:'uname'}" rowspan="2">设备名称</th>
                    <th lay-data="{align:'center'}" colspan="2">地址</th>
                    <th lay-data="{align:'center'}" colspan="2">金额</th>
                    <th lay-data="{align:'center'}" colspan="2">地址</th>
                    <th lay-data="{align:'center'}" colspan="2">金额</th>
                    <th lay-data="{align:'center'}" colspan="2">地址</th>
                    <th lay-data="{align:'center'}" colspan="2">金额</th>
                    </th>
                </tr>
                <tr>
                    <th lay-data="{field:'province'}">省</th>
                    <th lay-data="{field:'city'}">市</th>

                    <th lay-data="{field:'province'}">省</th>
                    <th lay-data="{field:'city'}">市</th>

                    <th lay-data="{field:'province'}">省</th>
                    <th lay-data="{field:'city'}">市</th>

                    <th lay-data="{field:'province'}">省</th>
                    <th lay-data="{field:'city'}">市</th>

                    <th lay-data="{field:'province'}">省</th>
                    <th lay-data="{field:'city'}">市</th>

                    <th lay-data="{field:'province'}">省</th>
                    <th lay-data="{field:'city'}">市</th>
                </tr>
            </thead> -->
        </table>

    </div>
    <div id="page"></div>
</div>
<!--曲线图弹窗-->
<div id="ui" style="display: none;">

    <form class="layui-form" id="enterprise-form">

        <div class="layui-row">
            <div class="layui-form-item">
                <label class="layui-form-label">开始时间</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="stimeCanvs" name="stimeCanvs" autocomplete="off">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">结束时间</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" id="etimeCanvs" name="etimeCanvs" autocomplete="off">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline" id="hide">
                    <div class="layui-input-block">
                        <button class="layui-btn  layui-btn-radius layui-btn-normal" lay-submit lay-filter="canvSub"
                            style="width: 90px;margin-left: 30px;">查询
                        </button>
                    </div>
                </div>
            </div>

        </div>

    </form>
    <div id="canvas_qxt" class="canv"></div>
    <form class="layui-form" id="sbC">
        <!-- <div class="layui-form-item" style="margin: 0;"></div> -->
        <!-- <span>
            <input type="checkbox" name="" value="123" title="写作写作写作" lay-skin="primary" checked lay-filter="c">
        </span> -->

        <!-- <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作写作写作写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked>
        <input type="checkbox" name="" title="写作" lay-skin="primary" checked> -->
    </form>
</div>
<script src="../js/layui.js"></script>
<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
<script src="../js/echarts.min.js"></script>
<!--<script src="../js/laydate/laydate.js"></script>-->
<script>

    layui.use(['form', 'laydate', 'layer', 'laypage', 'element', 'table'], function () {
        /*初始化模块*/
        var element = layui.element;
        var laypage = layui.laypage;
        var layer = layui.layer;
        var router = layui.router();
        var laydate = layui.laydate;
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;

        var ename = decodeURI(router.search.ename)


        //声明echarts配置项
        var canvas_qxt
        var resData = []   //后台总数据
        var d    //rowdata数据
        var xData = [];
        var morDataY = []
        var option = {
            grid: {
                left: '4%',
                right: '4%',
                containLabel: true
            },
            color: [],
            tooltip: {
                trigger: "axis", //坐标轴触发提示框
                axisPointer: {
                    lineStyle: {
                        color: '#C3CBD6'
                    }
                }

            },
            dataZoom: [

                {
                    type: "inside",
                    realtime: true,
                    start: 0,
                    end: 100
                },

            ],
            xAxis: [{
                type: 'category',
                boundaryGap: false,
                axisLine: {
                    lineStyle: {
                        color: '#57617B'
                    }
                },
                data: []
            }],
            yAxis: [{
                type: 'value',
                max: '',
                axisTick: {
                    show: false
                },
                axisLine: {
                    lineStyle: {
                        color: '#57617B'
                    }
                },
                axisLabel: {
                    margin: 10,
                    textStyle: {
                        fontSize: 14
                    }
                },
                splitLine: {
                    lineStyle: {
                        color: '#57617B'
                    }
                }
            }],
            series: [

            ]
        };

        //获取企业设备列表
        function getdevlist(mn) {
            $.ajax({
                url: httpUrl + 'rtds/factorList',
                data: {
                    mn: mn
                },
                dataType: 'json',
                success: function (res) {
                    layui.$('#mcodes').empty();
                    var data = res.data;
                    layui.$('#erpsname').text(res.erpsname);
                    var str = '<option value="" selected>请选择</option>';
                    for (var i = 0; i < data.length; i++) {
                        str += '<option value="' + data[i].mcode + '">' + data[i].uname + '</option>';
                    }

                    layui.$('#mcodes').append(str);

                    form.render();


                }
            });
        }
        /*全局变量*/
        var num   //有多少分页
        var newAr = []  //查询条件中间的所有时间集合
        var flag = false //flag为false是有分页，flag为true是首次进入或者是没有分页
        var ym = false  //用户是都点击了搜索，点击了则index重置

        /*设置默认时间（当前日期向前推5天）*/

        var day1 = new Date();
        var day2 = new Date();
        var y1 = day1.getFullYear()
        var m1 = day1.getMonth() + 1
        var d1 = day1.getDate()
        var h1 = day1.getHours();
        var mi1 = day1.getMinutes();
        var ys = mi1 % 5
        if (ys != 0) {
            day1 = new Date(day1.getTime() - ys * 60 * 1000)
            y1 = day1.getFullYear()
            m1 = day1.getMonth() + 1
            d1 = day1.getDate()
            h1 = day1.getHours();
            mi1 = day1.getMinutes();
        }
        day2 = new Date(day1.getTime() - 25 * 60 * 1000)
        var y2 = day2.getFullYear()
        var m2 = day2.getMonth() + 1
        var d2 = day2.getDate()
        var h2 = day2.getHours();
        var mi2 = day2.getMinutes();
        if (m1 <= 9) {
            m1 = "0" + m1;
        }
        if (d1 <= 9) {
            d1 = "0" + d1;
        }
        if (h1 <= 9) {
            h1 = "0" + h1
        }
        if (mi1 <= 9) {
            mi1 = "0" + mi1
        }
        if (m2 <= 9) {
            m2 = "0" + m2;
        }
        if (d2 <= 9) {
            d2 = "0" + d2;
        }
        if (h2 <= 9) {
            h2 = "0" + h2
        }
        if (mi2 <= 9) {
            mi2 = "0" + mi2
        }
        var s1 = y1 + "-" + m1 + "-" + d1 + ' ' + h1 + ":" + mi1 + ':00';
        var s2 = y2 + "-" + m2 + "-" + d2 + ' ' + h2 + ":" + mi2 + ':00';
        $('#stime').val(s2)
        $('#etime').val(s1)
        num = 0;
        AddDays($('#stime').val(), $('#etime').val()).then(function (arr) {
            if ($('#stime').val() && $('#etime').val()) {
                flag = true
                //获取企业列表
                $.ajax({
                    url: httpUrl + 'manage/erpsnamelist',
                    data: {
                        deptid: localStorage.getItem('deptid')
                    },
                    dataType: 'json',
                    success: function (data) {
                        var data = data.data;
                        var str = '';
                        for (var i = 0; i < data.length; i++) {
                            if (i == 0) {

                                str += '<option value="' + data[i].mn + '" selected>' + data[i].ename + '</option>';
                            } else {
                                str += '<option value="' + data[i].mn + '">' + data[i].ename + '</option>';
                            }

                        }
                        layui.$('#qylist').append(str);

                        if (router.search.mn) {
                            getdevlist($('#qylist').val())
                        }
                        form.render();
                        form.on('select(qy)', function () {
                            getdevlist($('#qylist').val())
                        })

                        rder()
                    }
                });

            }
        })



        /*判断开始时间和结束时间是否大于6天,是否有分页*/
        function pdFivedays(startTime, endTime) {
            return new Promise(function (resolve, reject) {
                startTime = startTime.replace(new RegExp(/-/gm), "/");
                endTime = endTime.replace(new RegExp(/-/gm), "/");
                var sdate = new Date(startTime);
                var now = new Date(endTime);
                var b = now.getMinutes()
                var a = sdate.getMinutes()
                var ysa = a % 5
                var ysb = b % 5
                var asd
                var bsd
                var ass
                var bss
                if (ysa != 0) {
                    asd = new Date(sdate.getTime() + (5 - ysa) * 60 * 1000)
                    ass = sdate.getTime() + (5 - ysa) * 60 * 1000
                } else {
                    asd = new Date(sdate.getTime())
                    ass = sdate.getTime()
                }
                if (ysb != 0) {
                    bsd = new Date(now.getTime() - ysb * 60 * 1000)
                    bss = now.getTime() - ysb * 60 * 1000
                } else {
                    bsd = new Date(now.getTime())
                    bss = now.getTime()
                }
                var asdA = asd.getFullYear()
                var asdB = asd.getMonth() + 1
                var asdC = asd.getDate()
                var asdD = asd.getHours();
                var asdE = asd.getMinutes()
                if (asdB <= 9) {
                    asdB = "0" + asdB;
                }
                if (asdC <= 9) {
                    asdC = "0" + asdC;
                }
                if (asdD <= 9) {
                    asdD = "0" + asdD
                }
                if (asdE <= 9) {
                    asdE = "0" + asdE
                }
                var newStart = asdA + "-" + asdB + "-" + asdC + ' ' + asdD + ":" + asdE + ':00';

                var bsdA = bsd.getFullYear()
                var bsdB = bsd.getMonth() + 1
                var bsdC = bsd.getDate()
                var bsdD = bsd.getHours();
                var bsdE = bsd.getMinutes()
                if (bsdB <= 9) {
                    bsdB = "0" + bsdB;
                }
                if (bsdC <= 9) {
                    bsdC = "0" + bsdC;
                }
                if (bsdD <= 9) {
                    bsdD = "0" + bsdD
                }
                if (bsdE <= 9) {
                    bsdE = "0" + bsdE
                }
                var newEnd = bsdA + "-" + bsdB + "-" + bsdC + ' ' + bsdD + ":" + bsdE + ':00';

                var days = bss - ass;
                var day = parseInt(days / (1000 * 60 * 5));
                console.log(parseInt(day));
                var arr = [day, newStart, newEnd]
                resolve(arr);
            })

        }

        //获取所有时间并每6个分组
        function AddDays(start, end) {
            return new Promise(function (resolve) {

                start = start.replace(new RegExp(/-/gm), "/");
                end = end.replace(new RegExp(/-/gm), "/");
                var ar = []
                var nd = new Date(start);
                var en = new Date(end);
                nd = nd.getTime();
                en = en.getTime();
                var jl = en - nd
                jl = jl / (5 * 60 * 1000)
                for (var k = 0; k < jl + 1; k++) {
                    var oa = nd + (k * 5 * 60 * 1000);
                    var dnd = new Date(oa);
                    var y = dnd.getFullYear();
                    var m = dnd.getMonth() + 1;
                    var d = dnd.getDate();
                    var h = dnd.getHours()
                    var mi = dnd.getMinutes()
                    if (m <= 9) m = "0" + m;
                    if (d <= 9) d = "0" + d;
                    if (h <= 9) h = "0" + h;
                    if (mi <= 9) mi = "0" + mi;
                    var cdate = y + "-" + m + "-" + d + ' ' + h + ":" + mi + ':00';
                    ar.push(cdate)
                }
                ar.splice(ar.length - 1, 1)
                //有无分页
                if (num) {
                    ar.reverse()

                    for (var k = 0; k < num; k++) {
                        var o = ar.splice(0, 5)

                        newAr.push(o)


                    }

                } else {
                    newAr = ar
                    newAr.reverse()
                }
                console.log(newAr)

                resolve(newAr)
            })

        }
        //重置
        form.on('submit(reset)', function (data) {
            ym = true

            // $('#qylist').val('')
            // $('#mcodes').val('')
            table.reload('tableid', {
                where: {
                    etime: layui.$('#etime').val(),
                    stime: layui.$('#stime').val(),
                    mn: layui.$('#qylist').val(),
                    mcode: layui.$('#mcodes').val()
                }
            });
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
        /*点击搜索*/
        form.on('submit(sub)', function (data) {

            if (data.field.stime && data.field.etime) {
                newAr = []
                ym = true
                pdFivedays(data.field.stime, data.field.etime).then(function (arrL) {

                    /*此处判断有多少分页（num）*/
                    if (arrL[0] > 5) {
                        flag = false
                        var opt = arrL[0] / 5 + "";
                        if (opt.indexOf(".") == -1) {
                            num = parseInt(Number(opt))
                        } else {
                            num = parseInt(Number(opt) + Number(1))
                            console.log(num)
                        }

                    } else {
                        num = 0;
                        flag = true
                    }

                    AddDays(arrL[1], arrL[2]).then(function (arr) {

                        if (num) {
                            var objW = {
                                etime: arr[0][0],
                                stime: arr[0][arr[0].length - 1],
                                mn: $('#qylist').val(),
                                mcode: layui.$('#mcodes').val()
                            }
                        } else {
                            var objW = {
                                etime: arr[0],
                                stime: arr[arr.length - 1],
                                mn: $('#qylist').val(),
                                mcode: layui.$('#mcodes').val()
                            }
                        }

                        table.reload('tableid', {
                            where: objW
                        });
                        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                    })

                })

            } else {
                layer.msg('开始时间或结束时间不能为空')
            }
        });


        /*index代表页码*/
        function rder(index, sTime, endTime) {

            var whereObj

            if (index == undefined) {
                index = 1
                whereObj = {
                    etime: layui.$('#etime').val(),
                    stime: layui.$('#stime').val(),
                    mn: layui.$('#qylist').val(),
                    mcode: layui.$('#mcodes').val()
                }
            } else {
                whereObj = {
                    etime: endTime,
                    stime: sTime,
                    mn: layui.$('#qylist').val(),
                    mcode: layui.$('#mcodes').val()
                }
            }
            table.render({
                elem: '#demo'
                , url: httpUrl + 'record/fiveMinute' //数据接口
                , where: whereObj
                , height: 'full-125'
                , page: false
                , cols: [],
                id: 'tableid',
                done: function (res, curr, count) {

                    var arrDa = res.data
                    var colArr = []
                    var co = [
                        // {
                        //     field: 'ename', title: '企业名称', width: 240, align: 'center', templet: function (d) {
                        //         return '<div style="text-align:left">' + d.ename + '</div>'
                        //     }
                        // }
                        {
                            field: 'uname', width: 160, title: '<img src="../images/img/sbsj.png">', align: 'center', templet: function (d) {
                                return '<div style="text-align:left">' + d.uname + '</div>'
                            }
                        }
                        , { field: 'day1', title: '' }
                        , { field: 'day2', title: '' }
                        , { field: 'day3', title: '' }
                        , { field: 'day4', title: '' }
                        , { field: 'day5', title: '' }
                        , {
                            field: 'day6', event: 'setSign', title: '曲线图', templet: function (datas) {

                                var o
                                o = '<img id="qxt" src=' + datas.day6 + ' style="padding-left:10px;cursor:pointer;">'
                                return o
                            }
                        }
                    ]
                    if (ym) {
                        index = 1
                    }
                    if (!flag) {

                        colArr = newAr[index - 1]
                        if (colArr && colArr.length > 0) {
                            for (var p = 0; p < colArr.length; p++) {
                                for (var y = 1; y < co.length; y++) {
                                    if (y == p + 1) {
                                        co[y].title = colArr[p]

                                    } else {
                                        if (y == co.length - 1) {
                                            break
                                        }
                                    }

                                }
                            }
                        }
                    }
                    if (flag) {

                        colArr = newAr
                        if (colArr && colArr.length > 0) {
                            for (var p = 0; p < colArr.length; p++) {
                                for (var y = 1; y < co.length; y++) {
                                    if (y == p + 1) {
                                        co[y].title = colArr[p]

                                    } else {
                                        if (y == co.length - 1) {
                                            break
                                        }
                                    }

                                }
                            }
                        }
                    }

                    var allD = []
                    for (var v = 0; v < arrDa.length; v++) {

                        var objI = {}
                        objI.uname = arrDa[v].uname
                        objI.ename = arrDa[v].ename
                        objI.mn = arrDa[v].mn
                        objI.unamee = arrDa[v].unamee
                        var arriD = arrDa[v].DayNumberList
                        var day = 'day'

                        for (var z = 0; z < co.length; z++) {
                            for (var c = 0; c < arriD.length; c++) {
                                var dda = arriD[c].datatime
                                dda = dda.split('.')

                                if (dda[0] == co[z].title) {
                                    var it = day + z
                                    objI[it] = arriD[c].cou
                                    break
                                }
                                if (c == arriD.length - 1) {
                                    var it = day + z

                                    if (co[z].title == "曲线图") {
                                        objI[it] = '../images/img/qxt.png'
                                    } else {
                                        objI[it] = '-'
                                    }
                                }
                            }

                        }

                        allD.push(objI)
                    }
                    console.log(allD)
                    laypage.render({
                        elem: 'page'
                        , count: Number(num * 10000)
                        , curr: ym ? 1 : index //如何点击搜索就是1
                        , limit: 10000
                        , groups: 7 //只显示 1 个连续页码
                        , first: '首页' //不显示首页
                        , last: '末页' //不显示尾页
                        , layout: ['prev', 'page', 'next'] //自定义分页布局
                        , jump: function (obj, first) {

                            if (!first) {
                                if (flag) {
                                    var sTime = newAr[0]
                                    var endTime = newAr[newAr.length - 1]
                                    rder(obj.curr, sTime, endTime)
                                } else {
                                    var arN = newAr[obj.curr - 1]
                                    var sTime = arN[arN.length - 1]
                                    var endTime = arN[0]
                                    rder(obj.curr, sTime, endTime)
                                }
                            }
                        }
                    })

                    table.init('demo', {//转换成静态表格
                        cols: [co],
                        data: allD
                        , limit: 10000
                        , height: 'full-185'
                    });

                    layui.$('th').css({
                        'background-color': '#4265ed',
                        'color': '#fff',
                        'font-weight': 'bold',
                        'text-align': 'center'
                    })
                    layui.$('td').css({
                        'text-align': 'center'
                    })

                    form.render();
                    layui.$('th').css({ 'background-color': '#1492ff', 'color': '#fff', 'font-weight': 'bold' });
                    ym = false
                }
            });
        }

        laydate.render({
            elem: '#stime'
            , type: 'datetime'
        });
        laydate.render({
            elem: '#etime'
            , type: 'datetime'
        });
        laydate.render({
            elem: '#stimeCanvs'
            , type: 'datetime'
        });
        laydate.render({
            elem: '#etimeCanvs'
            , type: 'datetime'
        });
        //console.log(router.search.mn);
        $('#qxt').on('click', function () {
            alert('123')
        })
        //监听行单击事件（双击事件为：rowDouble）
        table.on('tool(demo)', function (obj) {
            var rowData = obj.data;
            /*点击搜索*/
            form.on('submit(canvSub)', function (d) {
                option.yAxis[0].max = ''
                option.xAxis[0].data = []
                morDataY = []
                xData = []
                option.color = []
                option.series = []
                canvas_qxt.clear()
                canvas_qxt.setOption(option);
                qxDetail(rowData)
                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });
            layer.open({
                title: [rowData.ename, 'background:#1492FF;color:white'],
                type: 1,
                content: $('#ui'),
                area: ['880px', '680px'], //宽高
                success: function () {
                    $('#ui').css('display', 'block');
                    canvas_qxt = echarts.init(document.getElementById('canvas_qxt'));
                    //结束时间
                    var sn = new Date();
                    var snY = sn.getFullYear();
                    var snM = sn.getMonth() + 1;
                    var snD = sn.getDate();
                    var snH = sn.getHours();
                    var snMi = sn.getMinutes();
                    var snS = sn.getSeconds();
                    //开始时间
                    var ot = new Date(sn.getTime() - 12 * 60 * 60 * 1000)
                    var otY = ot.getFullYear()
                    var otM = ot.getMonth() + 1
                    var otD = ot.getDate()
                    var otH = ot.getHours();
                    var otMi = ot.getMinutes();
                    var otS = ot.getSeconds();

                    if (snM <= 9) {
                        snM = "0" + snM;
                    }
                    if (snD <= 9) {
                        snD = "0" + snD;
                    }
                    if (snH <= 9) {
                        snH = "0" + snH
                    }
                    if (snMi <= 9) {
                        snMi = "0" + snMi
                    }
                    if (snS <= 9) {
                        snS = "0" + snS
                    }

                    if (otM <= 9) {
                        otM = "0" + otM;
                    }
                    if (otD <= 9) {
                        otD = "0" + otD;
                    }
                    if (otH <= 9) {
                        otH = "0" + otH
                    }
                    if (otMi <= 9) {
                        otMi = "0" + otMi
                    }
                    if (otS <= 9) {
                        otS = "0" + otS
                    }
                    var eti = snY + "-" + snM + "-" + snD + ' ' + snH + ":" + snMi + ':' + snS;
                    var sti = otY + "-" + otM + "-" + otD + ' ' + otH + ":" + otMi + ':' + otS;
                    $('#stimeCanvs').val(sti);
                    $('#etimeCanvs').val(eti)
                    if ($('#stimeCanvs').val() && $('#etimeCanvs').val()) {
                        qxDetail(rowData)
                    }

                },
                cancel: function () {

                    $('#stimeCanvs').val('')
                    $('#etimeCanvs').val('')
                    option.yAxis[0].max = ''
                    option.xAxis[0].data = []
                    morDataY = []
                    xData = []
                    option.color = []
                    option.series = []
                    canvas_qxt.clear()
                    canvas_qxt.setOption(option);
                    $('#sbC').html('')
                    $('#ui').css('display', 'none')
                }
            });
        });

        var resData = []   //后台相应的总数组

        //折线图canvas请求数据
        var d

        function qxDetail(rowData) {
            d = rowData

            layui.$.ajax({
                url: httpUrl + 'erps/getdiagramData',
                type: 'get',
                data: {
                    mn: rowData.mn,
                    stime: $('#stimeCanvs').val(),
                    etime: $('#etimeCanvs').val()
                },
                dataType: 'json',
                beforeSend: function () {
                    canvas_qxt.showLoading({
                        text: '',
                        textStyle: { fontSize: 30, color: '#444' },
                        color: 'rgb(20,146,255)', //加载动画颜色
                        effectOption: { backgroundColor: 'rgba(0, 0, 0, 0)' }
                    });

                },
                success: function (dataC) {
                    resData = dataC.data;
                    if (resData && resData.length > 0) {

                        var list = []
                        for (var j = 0; j < resData.length; j++) {
                            var obj = {
                                name: resData[j].uname,
                                code: resData[j].unamee
                            }
                            list.push(obj)
                        }
                        var oad = ''
                        for (var m = 0; m < list.length; m++) {

                            if (rowData.unamee == list[m].code) {  //说明默认的选中是这个设备
                                oad += '<span>' +
                                    '<input type="checkbox" value="' + list[m].code + '" title="' + list[m].name + '" lay-skin="primary" lay-filter="c" checked>' +
                                    '</span>'
                            } else {
                                oad += '<span>' +
                                    '<input type="checkbox" value="' + list[m].code + '" title="' + list[m].name + '" lay-skin="primary" lay-filter="c">' +
                                    '</span>'
                            }
                        }
                        $('#sbC').html(oad)
                        form.render()
                        // debugger
                        //勾画默认设备的曲线图
                        for (var l = 0; l < resData.length; l++) {
                            if (rowData.unamee == resData[l].unamee) {
                                for (var t = 0; t < resData[l].DayNumberList.length; t++) {
                                    xData.push(resData[l].DayNumberList[t].datatime);
                                    morDataY.push(resData[l].DayNumberList[t].cou)
                                }
                            }
                        }
                        //循环获取最大值
                        var max = morDataY[0];
                        for (let k = 0; k < morDataY.length - 1; k++) {
                            max = max < morDataY[k + 1] ? morDataY[k + 1] : max
                        }
                        max = Math.ceil(max)

                        max = max + 10000
                        option.yAxis[0].max = max
                        option.color.push('#1E9FFF');
                        var obj = {
                            name: rowData.uname,
                            type: "line", //折线
                            animation: true, //是否开启动画
                            smooth: true, //在这里添加属性,使折线变顺滑
                            lineStyle: {
                                width: 2,
                                color: "#1E9FFF"
                            },
                            data: morDataY
                        }
                        // console.log(xData)
                        // console.log(morDataY)
                        option.xAxis[0].data = xData
                        option.series.push(obj)
                        canvas_qxt.setOption(option);
                    }

                },
                complete: function () {
                    canvas_qxt.hideLoading();
                },
            })

        }
        //每选中一个
        function selectOne(color, val) {
            var na
            xData = []
            morDataY = []
            for (var l = 0; l < resData.length; l++) {
                if (val == resData[l].unamee) {
                    na = resData[l].uname
                    for (var t = 0; t < resData[l].DayNumberList.length; t++) {
                        xData.push(resData[l].DayNumberList[t].datatime);
                        morDataY.push(resData[l].DayNumberList[t].cou)
                    }
                }
            }
            //循环获取最大值
            var max = morDataY[0];
            for (let k = 0; k < morDataY.length - 1; k++) {
                max = max < morDataY[k + 1] ? morDataY[k + 1] : max
            }
            max = Math.ceil(max)

            if (max != 0 && max > option.yAxis[0].max) {
                max = max + 10000
                option.yAxis[0].max = max
            }

            option.color.push(color);

            var obj = {
                name: na,
                type: "line", //折线
                animation: true, //是否开启动画
                smooth: true, //在这里添加属性,使折线变顺滑
                lineStyle: {
                    width: 2,
                    color: color
                },
                data: morDataY
            }

            option.xAxis[0].data = xData
            option.series.push(obj)
            canvas_qxt.setOption(option);
        }

        //取消选中一个
        function cancelOne(overScolor, name) {

            //先删除数据
            for (let i = 0; i < option.series.length; i++) {
                if (option.series[i].name == name) {
                    option.series.splice(i, 1);
                    break;
                }
            }
            //再删除颜色
            for (let k = 0; k < option.color.length; k++) {
                if (option.color[k] == overScolor) {
                    option.color.splice(k, 1); //再删除颜色
                    break;
                }
            }

            canvas_qxt.setOption(option, true);
        }

        //监听选中的设备设置随机的背景颜色
        form.on('checkbox(c)', function (data) {
            // debugger
            var val = data.value
            var name = data.elem.title
            if (data.elem.checked == true) {  //选中
                var r = Math.floor(Math.random() * 255);
                var g = Math.floor(Math.random() * 255);
                var b = Math.floor(Math.random() * 255);
                var color = 'rgb(' + r + ', ' + g + ', ' + b + ')';
                // var color = '#' + Math.floor(Math.random() * 0xffffff).toString(16);

                console.log(color)
                $(this).parent().find('i').css('background', color)
                $(this).parent().find('i').css('border', '1px solid ' + color)
                selectOne(color, val)
            } else {  //取消选中
                var overScolor = $(this).parent().find('i').css('background-color')   //获取到背景颜色
                $(this).parent().find('i').removeAttr('style', '')
                cancelOne(overScolor, name)
            }

        });
    });

</script>
</body>

</html>